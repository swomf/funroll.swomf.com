# kernel

There are two methodological directions
toward compiling your own kernel.

<figure><pre>
                   (begin from <span class="blue">zcat /proc/config.gz</span>)
(begin from <span class="red">make</span>                    ┌──────────────┐
 <span class="red">localmodconfig</span>)       ┌────┐       │SUBTRACTIVE   │
┌──────────────┐  ┌────┘    └────┐  │>start with   │
│additive      ├─►│ a kernel     │◄─┤ support flags│
│>start tiny w/│┌─┘ adapted to ┌─┘  │ for like     │
│ guessed flags││   our machine│    │ everything   │
│>add til your │└─┐            └─┐  │>remove flags │
│ system works │  │    ┌────┐    │  │ til no worky │
└──────────────┘  └────┘    └────┘  └──────────────┘
</pre></figure>

Left to middle is a "bloatless" "don't use XYZ
until you need it" philosophy
(since <span class="red">make localmodconfig</span> notes down any currently
loaded drivers — [example localmodconfig usage ⇗](https://wiki.gentoo.org/wiki/User:Flexibeast/guides/A_minimal_Gentoo_kernel_for_your_hardware)). However it's less
pragmatic since the occurrence of an issue,
such as some new peripheral you have ten minutes
to try out not working, means

1. You have no working kernel copy.
2. You must recompile the kernel asap.

Right to middle is lazier, since changing
a kernel setting and breaking something is fine
since you have a previous working copy.

Curiously, using gentoo-kernel-bin + secure boot
will FORCE that out-of-tree kernel modules (read: Nvidia)
need to be signed. The irony
is that the gentoo-kernel-bin obviously isn't
distributed with the private key you need to do
so ([source ⇗](https://wiki.gentoo.org/wiki/Signed_kernel_module_support#:~:text=by%20enabling%20Secure%20Boot)).

<span class="red">This is a Gentoo-specific UX issue.</span>

Therefore, in order to load Nvidia drivers with a
[Unified Kernel Image and
Secure Boot ⟹](/conf/boot),
I either need to compile my own kernel, use keyctl at every boot, or
use Shim ([source ⇗](https://wiki.gentoo.org/wiki/Signed_kernel_module_support#Automatically_signing_kernel_modules_.28Portage.29)).

Thankfully the <span class="red">UX issue</span> only applies
to _pre-built_ kernels, so I can simply do the following to
set up:

<div class="ml-3">
  <ol class="ol-override">
    <li class="ol-li-override">Install the system using
    gentoo-kernel-bin</li>
    <li class="ol-li-override">After booting, load the current config.gz into
    /usr/src/linux</li>
    <li>Recompile the kernel (and, in my case, its EFISTUB setup)</li>
  </ol>
</div>

<span class="bright">How-to:</span>

Use this:

```bash path=/etc/portage/package.use/kernel
sys-kernel/gentoo-sources symlink
sys-kernel/linux-firmware compress-zstd savedconfig
```

And then, with your system booted, copy the config but remove the key that we don't have. Then compile.

<pre><code><span class="magenta command"></span><span class="purple">cd</span> /usr/src/linux
<span class="magenta command"></span><span class="purple">zcat</span> /proc/config.gz | <span class="purple">tee</span> .config
<span class="magenta command"></span><span class="purple">sed</span> -i 's/CONFIG_MODULE_SIG_KEY.*//g' .config
<span class="magenta command"></span><span class="purple">sed</span> -i 's/CONFIG_LOCALVERSION.*//g' .config
<span class="magenta command"></span><span class="purple">make</span> -j8
<span class="grey"># Follow your own judgment on the prompts</span>
<span class="magenta command"></span><span class="purple">make</span> modules_install -j$(nproc)
<span class="magenta command"></span><span class="purple">make</span> install
</code></pre>

(Above, I removed CONFIG_MODULE_SIG_KEY because /var/tmp/wherever-Gentoo-devs-stored-their-key
doesn't exist. I also removed CONFIG_LOCALVERSION just for aesthetics.)

Don't forget to do normal boot prep stuff like such. If you were using
gentoo-kernel-bin this was likely automated.

<pre><code><span class="magenta command"></span><span class="purple">cd</span> /efi/EFI/Linux
<span class="magenta command"></span><span class="purple">mv</span> <em class="red">$old_kernel $somewhere_else</em>
<span class="magenta command"></span><span class="purple">uefi-mkconfig</span> <span class="grey"># or whatever you use e.g. efibootmgr</span>
<span class="magenta command"></span><span class="purple">sbctl</span> sign -s <em class="blue">$new_kernel</em> <span class="grey"># i.e. secure boot</span>
</code></pre>

Then sign the [Nvidia drivers ⟹](/conf/graphics)
using the kernel's autogenerated key (you may
need to reinstall said drivers).

(Unfortunately, this leads to a bad habit of leaving the signing
key in the /usr/src/linux directory.)

## See also

- [Setting up the boot process ⟹](/conf/boot)
- [Nvidia drivers ⟹](/conf/graphics)
